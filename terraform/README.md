# Создание сети, подсетей и машин

Данная конфигурация предполагает работу в одном из двух воркспейсов Терраформа:
* `stage`. Главное отличие от prod: устанавливает тестовые, то есть недееспособные сертификаты. 
Предназначен для тестовых запусков и отладки.
* `prod`. Устанавливаются настоящие сертификаты.

Если таких воркспейсов нет, их нужно создать:
```
terraform workspace new prod
terraform workspace new stage
```
Переключение между воркспейсами осуществляется командой:
```
terraform workspace select [prod|stage]
```

### Провайдер
В этой конфигурации используется провайдер Яндекс-Облака (определение в файле [providers.tf](providers.tf)).

### Переменные
**Важно**: файла с переменными в исходном наборе файлов нет. Этот файл автоматически 
генерируется скриптом [yc_setup.py](../scripts/yc_setup.py). Пример того, как может 
выглядеть автосгенерированный файл `variables.tf`: [variables.tf-example](variables.tf-example).

### Сети, подсети, NAT-инстанс
Определяются в файле [network.tf](network.tf). В конфигурации две подсети - публичная и 
приватная. В публичной находится только машина с прокси-сервером. Остальные располагаются 
в приватной. В приватной часте доступ к интернету, необходимый для установки ПО, 
обеспечивается с помощью NAT-инстанса ЯО.

### DNS
Система доменных имен имеет в основе один домен с поддоменами. Права на домен делегированы 
от регистратора в ЯО.

### Машины:
Машины создаются в файлах, названия которых имеют префикс `node-`. В ходе развертывания 
инфраструктуры создается 9 виртуальных машин. На всех, кроме прокси, используется 
образ Ubuntu 20.04. На прокси устанавливается образ Ubuntu 18.04 с установленным на нее 
NAT-инстансом от ЯО.

### Генерация инвентори для Ansible
Файл инвентори генерируется по итогам создания инфраструктуры, то есть сети и машин. В него 
передаются динамические значения (адреса созданных машин), а также в него посредством 
автосгенерированного файла с переменными передаются заданные пользователем или созданные 
скриптом секретные значения. Переменные для шаблона [inventory.tmpl](inventory.tmpl) 
задаются в файле [inventory.tf](inventory.tf)

### Запуск Ansible
По завершении создания инфраструктуры запускается сценарий [Ansible](../ansible).


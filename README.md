# Дипломный практикум для курса [DEVSYS-PDC-2](https://netology.ru/programs/dvpspdc)

[Задачи](https://github.com/ansakoy/devops-netology/blob/master/999/README.md)

Развертывание инфраструктуры в Яндекс.Облаке (ЯО).

## Требования
- Аккаунт в ЯО (его OAuth токен и ID директории)
- Бакет в ЯО (его access key и secret key)
- Домен
- Terraform >= 0.13
- Python >= 3.8

## Подготовка
Для удобства по возможности вся подготовительная работа с облаком автоматизирована. 
Для запуска требуется передать скрипту через файл `.env` 
минимальный набор индивидуальных параметров, а именно:
```
YANDEX_PASSPORT_OAUTH_TOKEN="<OAuth-токен аккаунта>"
CLOUD_ID="<ID облака, с которым предстоит работать>"
FOLDER_ID="<ID каталога, в котором все будет происходить>"
TF_VAR_ACCESS_KEY_ID="<Ключ доступа к бакету>"
TF_VAR_ACCESS_KEY_SECRET="<Секретный ключ бакета>"
DOMAIN="<Домен, на котором будет доступна инфраструктура>"
MYSQL_SLAVE_USER_PASS="<Пароль для реплики MySQL>"
MYSQL_WP_USER_PASS="<Пароль для пользователя wordpress в MySQL>"
GITLAB_ROOT_PASS="<Пароль для Гитлаба>"
```
Данный набор параметров подразумевает, что у пользователя уже есть 
в облаке каталог, с которым он будет работать, а также создан бакет, и для него известны 
ключи. Строго говоря, это не необходимые сведения (каталог тоже можно было бы 
создать при настройке, как и бакет). Возможно, в более продвинутой версии такого 
скрипта следует автоматизировать и эти моменты тоже.

Для корректной работы скрипта необходимо создать виртуальное окружение и установить 
в него требуемые зависимости:
```bash
#  создаем виртуальное окружение
python3.9 -m venv venvdiploma

# активируем его
. venvdiploma/bin/activate

# устанавливаем зависимости
pip install -r requirements.txt
```

Скрипт находится по адресу [scripts/yc_setup.py](scripts/yc_setup.py). В нем находится 
класс `YandexCloudConfig`, который инициализируется с параметрами:
- **`oauth_token`** (OAuth-токен аккаунта - принимается из .env)
- **`folder_id`** (ID директории - принимается из .env)
- **`sa_name`** (название сервисного аккаунта). Название сервисного аккаунта, в отличие от 
остальных, задается как строковое значение. Если аккаунта с таким именем в директории нет, 
он будет создан. Если он уже существует в нужной роли, ничего не изменится, а он просто будет 
использоваться в дальнейшей работе.

Класс имеет следующие публичные методы:
- `add_sa_role(<role>)` - принимает в качестве аргумента текстовый код роли, которую 
нужно дать сервисному аккаунту. Метод используется в случае, если аккаунт создается 
впервые или уже существующему нужно дать определенную роль.
- `generate_sa_key()` - генерирует ключ для выбранного сервисного аккаунта и сохраняет 
его в файл, который в дальнейшем будет передан Терраформу через переменные.
- `generate_variables_tf()` - генерирует файл variables.tf, необходимый для создания 
инфраструктуры. Этот файл служит для передачи ансиблу как данных, полученных 
при развертывании машин в ходе работы терраформа, так и данных, которые передаются через 
.env (в частности задаваемых пользователем паролей).

Таким образом, реальный файл variables.tf в данном решении отсутствует, есть только 
его образец. Актуальный файл генерируется вышеуказанным методом.

Также в питоновском модуле имеется полезная функция **`init_terraform_with_bucket`**. 
Ее задача в том, чтобы инициализировать терраформ с заданным бакетом. Т.к. ключи 
от бакета нельзя передать терраформу через переменные, их приходится передавать 
иначе. Можно использовать специальный файл. В данном решении питон просто запускает 
команду инициализации, передавая в нее заданные ключи.

## Пример варианта подготовки среды для дальнейшей работы:
Подготавливаем нужные действия в скрипте
```python
# yc_setup.py
...
if __name__ == '__main__':
    yacl = YandexCloudConfig(YANDEX_PASSPORT_OAUTH_TOKEN, FOLDER_ID, "my-sa")  # инициируем среду 
    yacl.add_sa_role("editor")  # даем роль сервисному аккаунту
    yacl.generate_sa_key()  # генерируем ключ для сервисного аккаунта в файл key.json
    yacl.generate_variables_tf() # генерируем terraform/variables.tf
    init_terraform_with_bucket() # инициализируем терраформ с бакетом
```
`init_terraform_with_bucket()` имеет смысл запускать только при первой инициализации 
данной конфигурации с бакетом. Во всех последующих запусков инициализацию 
можно производить просто командой `terraform init`.

Запускаем:
```bash
python yc_setup.py
```
## Создание инфраструктуры
```bash
terraform apply --auto-approve
```
Основные этапы:
- создаются сеть, подсети (публичная и приватная), таблицы маршрутизации
- генерируется инвентори для ансибла (ansible/inventory.ini)
- запускается сценарий ансибла, который:
  - настраивает nginx-бастион (reverse-proxy) с публичным адресом (остальные машины в приватной сети)
  - устанавливает MySQL для Wordpress и настраивает репликацию (2 машины - для мастера и слейва)
  - устанавливает Wordpress
  - устанавливает Gitlab и Gitlab-runner (разные машины)
  - # TODO
  
## Удаление инфраструктуры:
```bash
terraform destroy --auto-approve
```
  